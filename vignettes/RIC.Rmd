---
title: "Introduction to RIC analysis"
author: "Maria Dermit"
date: "`r BiocStyle::doc_date()`"
package: "`r pkg_ver('RIC')`"
output: 
   BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{RIC Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}
bibliography: ["RIC.bib"]
---

```{r required packages, echo = FALSE, warning=FALSE, results="hide"}
suppressPackageStartupMessages({
  library("BiocStyle")
  library("RIC")
  library(magrittr)
  library(tidyverse)

})
```


\pagebreak

# Abstract


`RIC` (RNA interaction capture) is a package that provides an analytical workflow of
mass spectrometry proteomics SILAC quantitative data from compariative RNA interaction capture (cRIC)  experiments [@Queiroz2019]. 
In this type of experiments, oligo DT capture and total cell lysate as used as input normalization... 

__Insert Schematic diagram of the cRIC method.__

RIC requires tabular input e.g. peptides.txt files output of quantitative analysis software like MaxQuant. Functions are provided for preparation, filtering, calculating SILAC ratios and generating  SummarizedExperiment objects, as well as statistical testing of differentially RBP due to a given biological condition/treatment. It also includes tools to check intermediate steps in the workflow, such as normalization. Finally, visualization tools are provided to explore the results, including barplots, scatter plots and volcano plots.


# Installation and loading package

Start R and install the RBP package:
```{r install, eval = FALSE}
if (!requireNamespace("BiocManager", quietly=TRUE))
    install.packages("BiocManager")
BiocManager::install("RIC")
library("RIC")
```

Once you have the package installed, load `RIC` and dplyr for data transformation into R. 

```{r setup, message=FALSE}
library(RIC)
library(dplyr)
library(SummarizedExperiment)
library(magrittr)
library(patchwork)
library(QFeatures)
```


# Getting  the data
We analyse the dataset from Garcia-Moreno et al 2019. There are three biological replicates 

The raw mass spectrometry data were first analyzed using MaxQuant [@Cox2014] and the resulting “peptides.txt” file is used as input for the  downstream analysis. These files are provided with the RIC package. Thanks to the Qfeatures readQFeatures function a text file can be read straight into a QFeatures object. 

```{r load-data}
# The data is provided with the package
WCLpeptidesfilepath<- system.file("extdata","WCL_peptides.txt", package = "RIC")
RICpeptidesfilepath<- system.file( "extdata", "RIC_peptides.txt", package = "RIC")
```
These would be the file path where your peptides.txt life.

The authors gave a slightly different name to the oligo DT (RIC) and  WCL experiment. We need to extract the intensity columns of interest.
```{r}
j <- str_which(colnames(WCLpeptides),str_c(c("Intensity.((\\D)).18_M_4","Intensity.((\\D)).4_18_M","Intensity.((\\D)).M_4_18"), collapse="|"))
i <- str_which(colnames(RICpeptides),str_c("Intensity.[H|M|L].", collapse="|"))

QWCLpeptides <- readQFeatures(WCLpeptidesfilepath, ecol = j, sep = "\t", name = "peptides", fnames = "Sequence")
QRICpeptides <- readQFeatures(RICpeptidesfilepath, ecol = i, sep = "\t", name = "peptides", fnames = "Sequence")

```

## Encoding the experimental desing

```{r}
sample_names=c('hour18','hour4','mock')
QWCLpeptides$group <- paste(sample_names,rep(1:3,each=3),sep='_')
QWCLpeptides$sample <- rep(1:3, each=3)
colData(QWCLpeptides)

QRICpeptides$group <-  paste(sample_names,rep(1:3,each=3),sep='_')
QRICpeptides$sample <- rep(1:3, each=3)
colData(QRICpeptides)

Qfeatures_list<-list(QRICpeptides,QWCLpeptides)


```

## Filtering the data

We filter for contaminant proteins  and decoy database hits which are indicated by "+" in the columns "Potential.contaminants" and "Reverse" respectively using  QFeatures-filtering functions.
```{r dim-data-filtered}
QWCLpeptidesfiltered <- QWCLpeptides %>% 
    filterFeatures(~ Reverse == "") %>%
    filterFeatures(~ Potential.contaminant == "")

QRICpeptidesfiltered <- QRICpeptides %>% 
    filterFeatures(~ Reverse == "") %>%
    filterFeatures(~ Potential.contaminant == "")

#do these steps with map
```

## Removing non-needed feature variables
We can retain rowDatanames of interest 
```{r QFeatures-selectRowData}
 
rowDataNames(QWCLpeptidesfiltered)[["peptides"]] %>% length() #139
rowDataNames(QRICpeptidesfiltered)[["peptides"]] %>% length() #142
 
rowvars <- c("Sequence", "Proteins", "Leading.razor.protein")
QWCLpeptidesfiltered_clean <- selectRowData(QWCLpeptidesfiltered, rowvars)
QRICpeptidesfiltered_clean <- selectRowData(QRICpeptidesfiltered, rowvars)

rowDataNames(QWCLpeptidesfiltered_clean)[["peptides"]] %>% length() #3
rowDataNames(QRICpeptidesfiltered_clean)[["peptides"]] %>% length() #3
```

## Visualizatoin of single-matched peptides
[@Queiroz2019] only considered peptides than can be mapped to a single gene. We can visualize 
how many genes each peptides match to.

```{r cheking-duplicated-pep2Ensg}
RIC::plot_singlepeptides(QWCLpeptidesfiltered_clean,SV_seq)
RIC::plot_singlepeptides(QRICpeptidesfiltered_clean,SV_seq)

```
As we can see, most peptides uniquely match to one gene. 

## Aggregation of mean intensity values for each ENSEMBL gene ID

```{r}
aggregatedWCL<-RIC::agregagte_singlepeptides(QWCLpeptidesfiltered_clean,SV_seq)
aggregatedRIC<-agregagte_singlepeptides(QRICpeptidesfiltered_clean,SV_seq)

```

## Plot batch effect
```{r}
RIC::plot_batcheffect(aggregatedWCL)
RIC::plot_batcheffect(aggregatedRIC)

```

## Remove batch effect
```{r}
batch2 <- c("A","A","A","B","B","B","C","C","C")
aggregatedWCL_batch<-RIC::remove_batcheffect(aggregatedWCL,batch2)

RIC::plot_batcheffect(aggregatedWCL_batch)

```

## semi-quantitative analysis
usethis::use_r("plot_scatterreplicates")

## RNA bindin activity
usethis::use_r("calculate_cRIC")

## Differential t-test
usethis::use_r("test_onesample")

## semi-quantitative analysis
usethis::use_r("semiq_cRIC")

## plot scatter cRIC
usethis::use_r("plot_scattercRIC")

## plot volcano cRIC
usethis::use_r("plot_volcanocRIC")



